# RHEL malware detection with Red Hat Insights

SSH to your RHEL9 box.

Register your box:

```bash
[root@vm2 ~]# subscription-manager register
Registering to: subscription.rhsm.redhat.com:443/subscription
Username: your-username
Password: 
The system has been registered with ID: xxx-xxx-xxx-xxx-xxx
The registered system name is: vm2.example.org
````

Install [Yara](https://virustotal.github.io/yara/): `dnf install yara -y`

Install the Insights Client: `dnf install insights-client -y`

Register your box with Insights (it connects to the account used by subscription-manager):

```bash
[root@vm2 ~]# insights-client --register
Successfully registered host vm2.example.org
Automatic scheduling for Insights has been enabled.
Starting to collect Insights data for vm2.example.org
Uploading Insights data.
Successfully uploaded report from vm2.example.org to account 123456.
View the Red Hat Insights console at https://console.redhat.com/insights/
```

Perform a test scan:

```bash
[root@vm2 ~]# insights-client --collector malware-detection
Starting to collect Insights data for vm2.example.org
Writing the malware-detection app default configuration to /etc/insights-client/malware-detection-config.yml

Performing a test scan of /etc/insights-client/malware-detection-config.yml and the current process (PID 14493) to verify the malware-detection app is installed and scanning correctly ...

Starting filesystem scan ...
Scanning specified files in /etc ...
Matched rule TEST_RedHatInsightsMalwareDetection in file /etc/insights-client/malware-detection-config.yml
Scan time for /etc: 0 seconds
Filesystem scan time: 00:00:00
Starting processes scan ...
Scanning process 14493 ...
Matched rule TEST_RedHatInsightsMalwareDetection in process 14493
Scan time for process 14493: 0 seconds
Processes scan time: 00:00:00
Found 2 rule matches.

Red Hat Insights malware-detection app test scan complete.
Test scan results are not recorded in the Insights UI (https://console.redhat.com/insights/malware)
To perform proper scans, please set test_scan: false in /etc/insights-client/malware-detection-config.yml

Uploading Insights data.
```

Log into [the Cloud Console](https://cloud.redhat.com).

**IMPORTANT:** given the sensitive nature of malware detection, you need to be an admin or your Red Hat account to access the malware section.

Navigate to Red Hat Enterprise Linux > Red Hat Insights > Malware

Find your new system that says "Not matched".

Disable the test scan:

```
sed -i 's/test_scan: true/test_scan: false/' /etc/insights-client/malware-detection-config.yml
```

Run the malware detection again: 

```
[root@vm2 ~]# sed -i 's/test_scan: true/test_scan: false/' /etc/insights-client/malware-detection-config.yml
[root@vm2 ~]# insights-client --collector malware-detection
Starting to collect Insights data for vm2.example.org
Skipping missing filesystem_scan_exclude item: '/cgroup'
Skipping missing filesystem_scan_exclude item: '/selinux'
Skipping missing filesystem_scan_exclude item: '/net'
Excluding specified filesystem items: ['/proc', '/sys', '/mnt', '/media', '/dev']
Starting filesystem scan ...
Scanning files in /afs ...
Scan time for /afs: 0 seconds
Scanning files in /boot ...
Scan time for /boot: 0 seconds
Scanning files in /etc ...
Scan time for /etc: 0 seconds
Scanning files in /home ...
Scan time for /home: 0 seconds
Scanning files in /opt ...
Scan time for /opt: 0 seconds
Scanning files in /root ...
Scan time for /root: 0 seconds
Scanning files in /run ...
Scan time for /run: 0 seconds
Scanning files in /srv ...
Scan time for /srv: 0 seconds
Scanning specified files in /tmp ...
Scan time for /tmp: 0 seconds
Scanning files in /usr ...
Scan time for /usr: 10 seconds
Scanning specified files in /var ...
Scan time for /var: 0 seconds
Filesystem scan time: 00:00:11
No rule matches found.

Uploading Insights data.
Successfully uploaded report for vm2.example.org.
```

If you check the console again, no match is found.

Download a malware test file (EICAR is perfectly safe to use!):

```bash
curl https://secure.eicar.org/eicar.com.txt > /root/mw.txt
```

Run the malware detection again: 

```
[root@vm2 ~]# insights-client --collector malware-detection
Starting to collect Insights data for vm2.example.org
Skipping missing filesystem_scan_exclude item: '/cgroup'
Skipping missing filesystem_scan_exclude item: '/selinux'
Skipping missing filesystem_scan_exclude item: '/net'
Excluding specified filesystem items: ['/proc', '/sys', '/mnt', '/media', '/dev']
[...]
Scan time for /opt: 0 seconds
Scanning files in /root ...
Matched rule XFTI_EICAR_AV_Test in file /root/mw.txt
Scan time for /root: 0 seconds
Scanning files in /run ...
Scan time for /run: 0 seconds
Found 1 rule match.
Please visit https://console.redhat.com/insights/malware for more information

Uploading Insights data.
Successfully uploaded report for vm2.example.org.
```

Check the cloud console again.

## Sources

- [Red Hat Insights Documentation](https://access.redhat.com/documentation/en-us/red_hat_insights/2023/html/assessing_and_reporting_malware_signatures_on_rhel_systems_with_the_insights_for_rhel_malware_service/con-mal-getting-started_malware-svc-getting-started)
- [Yara](https://virustotal.github.io/yara/)
